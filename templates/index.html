<script>
    // Dynamic API Base URL
    const API_BASE = window.location.origin + '/api';
    console.log('API Base URL:', API_BASE);

    // Load model metrics on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded, testing connection...');
        testConnection();
        setDefaultValues();
        
        // Add health check on load
        checkHealth();
    });

    // Health check function
    async function checkHealth() {
        try {
            const response = await fetch(`${API_BASE}/health`);
            const data = await response.json();
            console.log('Health check:', data);
            
            if (data.model_loaded && data.scaler_loaded) {
                console.log('Model is ready for predictions');
            } else {
                console.warn('Model still loading...');
                // Retry after 2 seconds if model isn't ready
                setTimeout(checkHealth, 2000);
            }
        } catch (error) {
            console.error('Health check failed:', error);
            // Retry after 2 seconds
            setTimeout(checkHealth, 2000);
        }
    }

    // Set default values for testing
    function setDefaultValues() {
        document.getElementById('Trip_Distance_km').value = '15.5';
        document.getElementById('Trip_Duration_Minutes').value = '25';
        document.getElementById('Passenger_Count').value = '2';
        document.getElementById('Base_Fare').value = '3.50';
        document.getElementById('Per_Km_Rate').value = '1.20';
        document.getElementById('Per_Minute_Rate').value = '0.30';
        document.getElementById('Time_of_Day').value = 'Afternoon';
        document.getElementById('Day_of_Week').value = 'Weekday';
        document.getElementById('Traffic_Conditions').value = 'Medium';
        document.getElementById('Weather').value = 'Clear';
    }

    // Handle form submission
    document.getElementById('predictionForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!validateForm()) {
            return;
        }
        
        const inputData = collectFormData();
        console.log('Collected form data:', inputData);
        await predictFare(inputData);
    });

    // Collect form data
    function collectFormData() {
        const inputData = {};

        // Get all form fields
        const fields = [
            'Trip_Distance_km', 'Trip_Duration_Minutes', 'Passenger_Count',
            'Time_of_Day', 'Day_of_Week', 'Traffic_Conditions', 'Weather',
            'Base_Fare', 'Per_Km_Rate', 'Per_Minute_Rate'
        ];

        fields.forEach(field => {
            const element = document.getElementById(field);
            if (element) {
                // Convert numeric fields to numbers, keep categorical as strings
                if (field.includes('Distance') || field.includes('Duration') || 
                    field.includes('Count') || field.includes('Fare') || 
                    field.includes('Rate')) {
                    inputData[field] = parseFloat(element.value);
                } else {
                    inputData[field] = element.value;
                }
            }
        });

        return inputData;
    }

    // Validate form
    function validateForm() {
        const requiredFields = [
            'Trip_Distance_km', 'Trip_Duration_Minutes', 'Passenger_Count',
            'Time_of_Day', 'Day_of_Week', 'Traffic_Conditions', 'Weather',
            'Base_Fare', 'Per_Km_Rate', 'Per_Minute_Rate'
        ];

        for (const fieldId of requiredFields) {
            const field = document.getElementById(fieldId);
            if (!field || !field.value) {
                showError(`Please fill in ${fieldId.replace(/_/g, ' ')}`);
                if (field) field.focus();
                return false;
            }
        }
        return true;
    }

    // Predict fare function with better error handling
    async function predictFare(inputData) {
        showLoading(true);
        hideResults();

        try {
            console.log('Sending prediction request:', inputData);
            
            const response = await fetch(`${API_BASE}/predict`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(inputData)
            });

            console.log('Response status:', response.status);
            
            const data = await response.json();
            console.log('Prediction response:', data);

            if (!response.ok) {
                // Handle specific error cases
                if (response.status === 503) {
                    throw new Error('Model is still loading. Please try again in a moment.');
                } else if (data.error && data.error.includes('encoding')) {
                    throw new Error('Invalid input values. Please check your selections.');
                } else {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
            }

            if (data.error) {
                showError(data.error);
            } else {
                showPrediction(data.predicted_price);
            }
        } catch (error) {
            console.error('Prediction error:', error);
            
            // User-friendly error messages
            let userMessage = error.message;
            if (error.message.includes('Failed to fetch')) {
                userMessage = 'Cannot connect to the server. Please check your connection and try again.';
            } else if (error.message.includes('encoding') || error.message.includes('Invalid value')) {
                userMessage = 'Invalid input values detected. Please check all fields and try again.';
            } else if (error.message.includes('Model is still loading')) {
                userMessage = 'The prediction model is still initializing. Please wait a moment and try again.';
            }
            
            showError(`Prediction failed: ${userMessage}`);
        } finally {
            showLoading(false);
        }
    }

    // ... rest of the JavaScript functions remain the same ...
</script>